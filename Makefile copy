SERVICES := $(filter-out $@,$(MAKECMDGOALS))

%:
	@:

export REPO_ROOT := $(PWD)
export CONFIG_ROOT := $(PWD)/configs
export DATA_ROOT := $(PWD)/data

PROJECT_NAME=mlops-construction-cost-prediction
PROJECT_NAME_DEV=$(PROJECT_NAME)-dev

COMPOSE_DEV = docker compose -f deployments/compose.yaml -f deployments/compose.dev.yaml
COMPOSE_PROD = docker compose -f deployments/compose.yaml -f deployments/compose.prod.yaml

.PHONY: help \
	start start-dev \
	stop stop-dev \
	restart restart-dev \
	clean clean-dev \
	rebuild rebuild-dev \
	logs logs-dev \
	ps ps-dev \
	build-arm \
	test \
	rebuild-service-dev \
	logs-service-dev

help:
	@echo "Available commands:"
	@echo "  make start        Start full stack (prod-like)"
	@echo "  make start-dev    Start stack in dev mode"
	@echo "  make stop         Stop prod stack"
	@echo "  make stop-dev     Stop dev stack"
	@echo "  make restart      Restart prod stack"
	@echo "  make restart-dev  Restart dev stack"
	@echo "  make clean        Stop and remove prod volumes"
	@echo "  make clean-dev    Stop and remove dev volumes"
	@echo "  make rebuild      Full rebuild prod stack"
	@echo "  make rebuild-dev  Full rebuild dev stack"
	@echo "  make rebuild-service-dev SERVICE=<name>  Rebuild specific dev service"
	@echo "  make logs         Follow prod logs"
	@echo "  make logs-dev     Follow dev logs"
	@echo "  make logs-service-dev SERVICE=<name>     Follow specific dev service logs"
	@echo "  make ps           Show prod services"
	@echo "  make ps-dev       Show dev services"
	@echo "  make build-arm    Build ARM64 images with buildx"
	@echo "  make test         Run unit tests"

start:
	$(COMPOSE_PROD) -p $(PROJECT_NAME) up -d --build postgres
	$(COMPOSE_PROD) -p $(PROJECT_NAME) run --rm airflow-init
	$(COMPOSE_PROD) -p $(PROJECT_NAME) up -d $(SERVICES)

start-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d --build postgres
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) run --rm airflow-init
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d $(SERVICES)

stop:
	$(COMPOSE_PROD) -p $(PROJECT_NAME) down $(SERVICES)

stop-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) down $(SERVICES)

restart:
	$(MAKE) stop $(SERVICES)
	$(MAKE) start $(SERVICES)

restart-dev:
	$(MAKE) stop-dev $(SERVICES)
	$(MAKE) start-dev $(SERVICES)

clean:
	$(COMPOSE_PROD) -p $(PROJECT_NAME) down -v

clean-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) down -v

build:
	$(COMPOSE_PROD) -p $(PROJECT_NAME) build --no-cache $(SERVICES)

build-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) build --no-cache $(SERVICES)

rebuild:
	$(MAKE) stop $(SERVICES)
	$(MAKE) build $(SERVICES)
	$(MAKE) start $(SERVICES)

rebuild-dev:
	@echo "Rebuilding services: $(SERVICES)"
	$(MAKE) stop-dev $(SERVICES)
	$(MAKE) build-dev $(SERVICES)
	$(MAKE) start-dev $(SERVICES)
	@echo "Rebuild complete"

bootstrap:
	$(MAKE) clean
	$(MAKE) build
	$(MAKE) start

bootstrap-dev:
	$(MAKE) clean-dev
	$(MAKE) build-dev
	$(MAKE) start-dev

logs:
	$(COMPOSE_PROD) -p $(PROJECT_NAME) logs -f $(SERVICES)

logs-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) logs -f $(SERVICES)

ps:
	$(COMPOSE_PROD) -p $(PROJECT_NAME) ps $(SERVICES)

ps-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) ps $(SERVICES)

# ----------------------------
# Parameterizable targets
# ----------------------------

# Rebuild a specific service in dev environment
# Usage: make rebuild-service-dev SERVICE=inference-api
rebuild-service-dev:
	@if [ -z "$(SERVICE)" ]; then \
		echo "Error: SERVICE parameter is required"; \
		echo "Usage: make rebuild-service-dev SERVICE=<service_name>"; \
		exit 1; \
	fi
	@echo "Rebuilding service: $(SERVICE)"
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) build --no-cache $(SERVICE)
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d --force-recreate $(SERVICE)
	@echo "Service $(SERVICE) rebuilt successfully"

# Follow logs of a specific service in dev environment
# Usage: make logs-service-dev SERVICE=inference-api
logs-service-dev:
	@if [ -z "$(SERVICE)" ]; then \
		echo "Error: SERVICE parameter is required"; \
		echo "Usage: make logs-service-dev SERVICE=<service_name>"; \
		exit 1; \
	fi
	@echo "Following logs for service: $(SERVICE)"
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) logs -f $(SERVICE)


build-arm:
	docker buildx build --platform linux/arm64 -t $(PROJECT_NAME)-mlflow -f deployments/mlflow/Dockerfile.mlflow .
	docker buildx build --platform linux/arm64 -t $(PROJECT_NAME)-airflow -f deployments/airflow/Dockerfile.airflow .
	docker buildx build --platform linux/arm64 -t $(PROJECT_NAME)-inference -f api/inference_api/Dockerfile .
	docker buildx build --platform linux/arm64 -t $(PROJECT_NAME)-streamlit -f deployments/streamlit/Dockerfile.streamlit .

test:
	pytest -v tests/unit/



# ----------------------------
# Service-level rebuild
# ----------------------------

rebuild-inference-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) build --no-cache inference-api
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d --force-recreate inference-api

rebuild-gateway-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) build --no-cache gateway-api
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d --force-recreate gateway-api

build-gateway-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) build --no-cache gateway-api	

rebuild-streamlit-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) build --no-cache streamlit
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d --force-recreate streamlit

	
rebuild-prometheus-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) build --no-cache prometheus
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d --force-recreate prometheus

rebuild-grafana-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) build --no-cache grafana
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d --force-recreate grafana

# ----------------------------
# Service-level logs
# ----------------------------

logs-inference-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) logs -f inference-api

logs-streamlit-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) logs -f streamlit

logs-mlflow-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) logs -f mlflow

logs-airflow-webserver-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) logs -f airflow-webserver

logs-airflow-scheduler-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) logs -f airflow-scheduler


# restart

restart-inference-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) restart inference-api

restart-streamlit-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) restart streamlit

restart-frontend-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) restart inference-api streamlit

start-frontend-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d inference-api gateway-api streamlit


restart-nginx-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d --force-recreate nginx

start-nginx-dev:
	$(COMPOSE_DEV) -p $(PROJECT_NAME_DEV) up -d