apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-initdb
data:
  init-databases.sh: |
    #!/bin/bash
    set -e

    GATEWAY_DB_NAME="${GATEWAY_DB_NAME:-gateway_api}"
    GATEWAY_DB_USER="${GATEWAY_DB_USER:-gateway}"
    GATEWAY_DB_PASSWORD="${GATEWAY_DB_PASSWORD:-gateway}"

    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        CREATE DATABASE mlflow;
        CREATE USER mlflow WITH PASSWORD 'mlflow';
        GRANT ALL PRIVILEGES ON DATABASE mlflow TO mlflow;

        -- Grant schema permissions (required for PostgreSQL 15+)
        \c mlflow
        GRANT ALL ON SCHEMA public TO mlflow;

        -- Gateway API database/user
        \c $POSTGRES_DB
        CREATE DATABASE $GATEWAY_DB_NAME;
        CREATE USER $GATEWAY_DB_USER WITH PASSWORD '$GATEWAY_DB_PASSWORD';
        GRANT ALL PRIVILEGES ON DATABASE $GATEWAY_DB_NAME TO $GATEWAY_DB_USER;

        \c $GATEWAY_DB_NAME
        GRANT ALL ON SCHEMA public TO $GATEWAY_DB_USER;
    EOSQL

---
apiVersion: v1
kind: Service
metadata:
  name: postgres
spec:
  selector:
    app: postgres
  ports:
    - name: postgres
      port: 5432
      targetPort: 5432

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15
          ports:
            - containerPort: 5432
              name: postgres
          envFrom:
            - secretRef:
                name: mlops-secrets
          env:
            - name: GATEWAY_DB_NAME
              value: gateway_api
            - name: GATEWAY_DB_USER
              value: gateway
            - name: GATEWAY_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mlops-secrets
                  key: GATEWAY_DB_PASSWORD
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
            - name: initdb
              mountPath: /docker-entrypoint-initdb.d/init-databases.sh
              subPath: init-databases.sh
              readOnly: true
          readinessProbe:
            tcpSocket:
              port: 5432
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 5432
            initialDelaySeconds: 30
            periodSeconds: 20
      volumes:
        - name: initdb
          configMap:
            name: postgres-initdb
            defaultMode: 0755
        - name: postgres-data
          persistentVolumeClaim:
            claimName: postgres-pvc
