name: ci

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  test-unit:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Load environment variables from .env.test
        run: |
          sed -e '/^[[:space:]]*#/d' -e '/^[[:space:]]*$/d' -e '/^SLACK_WEBHOOK_URL=/d' .env.test >> "$GITHUB_ENV"

      - name: Debug loaded env vars (safe)
        run: |
          echo "Loaded env vars from .env.test:"
          while IFS= read -r line; do
            key="${line%%=*}"
            [ -z "$key" ] && continue
            val="${!key}"
            if [[ "$key" =~ (SECRET|PASSWORD|TOKEN|KEY|WEBHOOK) ]]; then
              echo "${key}=***"
            else
              echo "${key}=${val}"
            fi
          done < <(sed -e '/^[[:space:]]*#/d' -e '/^[[:space:]]*$/d' .env.test)

      - name: Run unit tests
        run: |
          pytest -v tests/unit/

      - name: Slack notification
        if: ${{ always() && env.SLACK_WEBHOOK_URL != '' }}
        run: |
          STATUS="${{ job.status }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Workflow Unit Tests *${{ github.workflow }}* (${STATUS})\nRepo: ${{ github.repository }}\nRun: ${RUN_URL}\"}" \
            "${SLACK_WEBHOOK_URL}"

  test-integration:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      RUN_INTEGRATION_TESTS: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Load environment variables from .env.test
        run: |
          sed -e '/^[[:space:]]*#/d' -e '/^[[:space:]]*$/d' -e '/^SLACK_WEBHOOK_URL=/d' .env.test >> "$GITHUB_ENV"

      - name: Debug loaded env vars (safe)
        run: |
          echo "Loaded env vars from .env.test:"
          while IFS= read -r line; do
            key="${line%%=*}"
            [ -z "$key" ] && continue
            val="${!key}"
            if [[ "$key" =~ (SECRET|PASSWORD|TOKEN|KEY|WEBHOOK) ]]; then
              echo "${key}=***"
            else
              echo "${key}=${val}"
            fi
          done < <(sed -e '/^[[:space:]]*#/d' -e '/^[[:space:]]*$/d' .env.test)

      - name: Prepare Docker env file
        run: |
          cp deployments/.env.example deployments/.env

      - name: Start Docker services
        run: |
          docker compose --env-file deployments/.env -f deployments/compose.yaml -f deployments/compose.dev.yaml up -d postgres gateway-api inference-api
          echo "Waiting for services to be ready..."
          sleep 40

      - name: Check service health
        run: |
          docker compose --env-file deployments/.env -f deployments/compose.yaml -f deployments/compose.dev.yaml ps

      - name: Run integration tests
        run: |
          pytest -v tests/integration/

      - name: Stop Docker services
        if: always()
        run: |
          docker compose --env-file deployments/.env -f deployments/compose.yaml -f deployments/compose.dev.yaml down

      - name: Slack notification
        if: ${{ always() && env.SLACK_WEBHOOK_URL != '' }}
        run: |
          STATUS="${{ job.status }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Workflow Integration Tests *${{ github.workflow }}* (${STATUS})\nRepo: ${{ github.repository }}\nRun: ${RUN_URL}\"}" \
            "${SLACK_WEBHOOK_URL}"

  docker:
    needs: [test-unit, test-integration]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker images
        run: |
          docker build \
            -t ghcr.io/${{ github.repository_owner }}/gateway-api:${{ github.sha }} \
            -t ghcr.io/${{ github.repository_owner }}/gateway-api:prod \
            api/gateway-api
          docker build \
            -t ghcr.io/${{ github.repository_owner }}/inference-api:${{ github.sha }} \
            -t ghcr.io/${{ github.repository_owner }}/inference-api:prod \
            api/inference-api
          docker build \
            -t ghcr.io/${{ github.repository_owner }}/streamlit:${{ github.sha }} \
            -t ghcr.io/${{ github.repository_owner }}/streamlit:prod \
            app/ml_platform
          docker build \
            -t ghcr.io/${{ github.repository_owner }}/airflow:${{ github.sha }} \
            -t ghcr.io/${{ github.repository_owner }}/airflow:prod \
            deployments/airflow
          docker build \
            -t ghcr.io/${{ github.repository_owner }}/mlflow:${{ github.sha }} \
            -t ghcr.io/${{ github.repository_owner }}/mlflow:prod \
            deployments/mlflow
          docker build \
            -t ghcr.io/${{ github.repository_owner }}/nginx:${{ github.sha }} \
            -t ghcr.io/${{ github.repository_owner }}/nginx:prod \
            deployments/nginx

      - name: Push Docker images to registry
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/gateway-api:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/inference-api:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/streamlit:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/airflow:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/mlflow:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/nginx:${{ github.sha }}